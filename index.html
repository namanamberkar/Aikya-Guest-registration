<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Guest Registration</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .guest-form { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
    label { display: block; margin-top: 8px; font-weight: bold; }
    input, select { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 12px; padding: 8px 16px; }
  </style>
</head>
<body>
  <h1>Guest Registration Form</h1>
  <form id="mainForm">
    <div id="guestContainer"></div>
    <button type="button" onclick="addGuest()">➕ Add Guest</button>
    <button type="submit">Submit All</button>
  </form>

  <div id="result"></div>

  <script>
    let guestCount = 0;

    function addGuest() {
      guestCount++;
      const container = document.getElementById("guestContainer");

      const div = document.createElement("div");
      div.className = "guest-form";
      div.innerHTML = `
        <h3>Guest ${guestCount}</h3>
        <label>Name: <input type="text" name="name" required></label>
        <label>DOB: <input type="date" name="dob" required></label>
        <label>Gender: 
          <select name="gender" required>
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </label>
        <label>WhatsApp Contact Number: <input type="tel" name="whatsapp" required></label>
        <label>Subscribe for Alerts:
          <select name="subscribe" required>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </label>
        <label>Upload Identity Card: <input type="file" name="idCard" accept="image/*,application/pdf" required></label>
        <p><small>Max 2MB. Passport, Driving License, Voter ID, Aadhaar.</small></p>
        <label>Check In Date: <input type="date" name="checkInDate" required></label>
        <label>Check In Time: <input type="time" name="checkInTime" required></label>
        <label>Check Out Date: <input type="date" name="checkOutDate" required></label>
        <label>Check Out Time: <input type="time" name="checkOutTime" required></label>
      `;
      container.appendChild(div);
    }

    // Add first guest by default
    addGuest();

    document.getElementById("mainForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const results = [];

      const guests = document.querySelectorAll(".guest-form");
      for (const guest of guests) {
        const name = guest.querySelector("[name='name']").value;
        const dob = guest.querySelector("[name='dob']").value;
        const gender = guest.querySelector("[name='gender']").value;
        const whatsapp = guest.querySelector("[name='whatsapp']").value;
        const subscribe = guest.querySelector("[name='subscribe']").value;
        const idCardFile = guest.querySelector("[name='idCard']").files[0];
        const checkInDate = guest.querySelector("[name='checkInDate']").value;
        const checkInTime = guest.querySelector("[name='checkInTime']").value;
        const checkOutDate = guest.querySelector("[name='checkOutDate']").value;
        const checkOutTime = guest.querySelector("[name='checkOutTime']").value;

        if (!idCardFile) {
          results.push({ name, success: false, error: "No file selected" });
          continue;
        }

        const base64 = await toBase64(idCardFile);

        const payload = {
          name,
          date: checkInDate, // Apps Script expects a `date` field → use check-in date
          fileName: idCardFile.name,
          mimeType: idCardFile.type,
          fileBase64: base64.split(",")[1], // remove prefix
          // extra guest fields (optional - won't break script)
          dob, gender, whatsapp, subscribe,
          checkInDate, checkInTime, checkOutDate, checkOutTime,
        };

        try {
          const res = await fetch("http://localhost:3000/upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          results.push({ name, ...data });
        } catch (err) {
          results.push({ name, success: false, error: err.message });
        }
      }

      document.getElementById("result").innerText = JSON.stringify(results, null, 2);
    });

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
